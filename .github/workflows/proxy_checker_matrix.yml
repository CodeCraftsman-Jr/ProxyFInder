name: Ultra-Fast Parallel Proxy Checker (Matrix)

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  # Matrix strategy: Run all 3 proxy types simultaneously
  check-proxies-matrix:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 3  # Run all 3 jobs in parallel
      fail-fast: false  # Don't cancel other jobs if one fails
      matrix:
        proxy_type: [http, socks4, socks5]
    
    name: Check ${{ matrix.proxy_type }} proxies
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        pip install -r requirements-github-actions.txt
        
    - name: Run ${{ matrix.proxy_type }} proxy checker
      env:
        APPWRITE_ENDPOINT: ${{ secrets.APPWRITE_ENDPOINT }}
        APPWRITE_PROJECT_ID: ${{ secrets.APPWRITE_PROJECT_ID }}
        APPWRITE_API_KEY: ${{ secrets.APPWRITE_API_KEY }}
        APPWRITE_DATABASE_ID: ${{ secrets.APPWRITE_DATABASE_ID }}
        APPWRITE_COLLECTION_ID: ${{ secrets.APPWRITE_COLLECTION_ID }}
        PROXY_TYPE: ${{ matrix.proxy_type }}
      run: |
        echo "ðŸš€ Testing ${{ matrix.proxy_type }} proxies..."
        python github_actions_proxy_checker.py
      
    - name: Upload ${{ matrix.proxy_type }} proxies as artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: working-${{ matrix.proxy_type }}-proxies-${{ github.run_number }}
        path: working_proxies/working_${{ matrix.proxy_type }}_*
        retention-days: 7
        if-no-files-found: warn

  # Combine results after all matrix jobs complete
  combine-results:
    runs-on: ubuntu-latest
    needs: check-proxies-matrix
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: all-proxies
        
    - name: List downloaded artifacts
      run: |
        echo "ðŸ“¦ Downloaded artifacts:"
        find all-proxies -type f -name "*.txt" -o -name "*.json"
        
    - name: Generate combined summary
      run: |
        echo "# ðŸ“Š Ultra-Fast Parallel Proxy Checker Summary" > summary.md
        echo "" >> summary.md
        echo "**Run:** #${{ github.run_number }}" >> summary.md
        echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> summary.md
        echo "**Strategy:** Matrix parallel execution (3 jobs simultaneously)" >> summary.md
        echo "" >> summary.md
        echo "## ðŸŽ¯ Results by Type" >> summary.md
        echo "" >> summary.md
        
        total=0
        for type in http socks4 socks5; do
          file="all-proxies/working-${type}-proxies-${{ github.run_number }}/working_${type}_proxies.txt"
          if [ -f "$file" ]; then
            count=$(wc -l < "$file" 2>/dev/null || echo "0")
            total=$((total + count))
            echo "- âœ… **${type^^}**: $count working proxies" >> summary.md
          else
            echo "- âŒ **${type^^}**: 0 working proxies (no file found)" >> summary.md
          fi
        done
        
        echo "" >> summary.md
        echo "## ðŸ“ˆ Total Working Proxies: $total" >> summary.md
        echo "" >> summary.md
        echo "---" >> summary.md
        echo "*Generated by GitHub Actions with Matrix Strategy*" >> summary.md
        
        cat summary.md
        cat summary.md >> $GITHUB_STEP_SUMMARY
        
    - name: Upload combined summary
      uses: actions/upload-artifact@v4
      with:
        name: summary-${{ github.run_number }}
        path: summary.md
        retention-days: 30

    - name: Create all-proxies combined file
      run: |
        mkdir -p combined
        for type in http socks4 socks5; do
          file="all-proxies/working-${type}-proxies-${{ github.run_number }}/working_${type}_proxies.txt"
          if [ -f "$file" ]; then
            cat "$file" >> combined/all_working_proxies.txt
          fi
        done
        
        if [ -f "combined/all_working_proxies.txt" ]; then
          echo "âœ… Created combined proxy file with $(wc -l < combined/all_working_proxies.txt) total proxies"
        fi
    
    - name: Upload combined proxy list
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: all-working-proxies-${{ github.run_number }}
        path: combined/
        retention-days: 30
        if-no-files-found: warn
